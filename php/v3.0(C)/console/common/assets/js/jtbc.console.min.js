var jtbc=window.jtbc||{};jtbc.console={obj:null,param:[],parent:jtbc,root:null,manageURL:'manage.php',managerapiURL:'managerapi.php',materialFolder:'universal/material/',bindEventsByMode:function(r){var s=this;var t=r;t.find('*[mode]').each(function(){var h=$(this);if(h.attr('modebinded')!='true'){h.attr('modebinded','true');if(h.attr('mode')=='aloneTips'){if(h.parent().find(this.tagName).length==h.parent().find(this.tagName+'.hide').length)h.removeClass('hide')}else if(h.attr('mode')=='ajaxPost'){h.find('button.submit').on('click',function(){var f=$(this);h.find('textarea.editor').each(function(){try{var a=$(this);var b=a.attr('editor-index');var c=s.param['editor-instance-'+b];a.val(s.parent.editor.getHTML(c,a.attr('name')))}catch(e){}});if(!f.hasClass('lock')){f.addClass('lock');f.trigger('before');var g=s.param['current-main-fileurl']+h.attr('action');$.post(g,h.serialize(),function(a){var b=$(a);f.attr('msg',b.find('result').attr('message')).removeClass('lock');if(b.find('result').attr('status')=='0'){if(f.attr('message')=='custom')f.trigger('message');else{var c=h.find('.form_tips').html('').append('<ul></ul>').find('ul');var d=f.attr('msg').split('|');for(var i in d)c.append('<li>'+d[i]+'</li>')}}else if(b.find('result').attr('status')=='1'){if(f.attr('done')=='custom')f.trigger('done');else if(typeof(f.attr('doneclick'))!='undefined')s.obj.find(f.attr('doneclick')).trigger('click');else h.find('.form_tips').html('<em>'+f.attr('msg')+'</em>')}})}})}else if(h.attr('mode')=='att'){var j=h.parent();var k=h.attr('editor');if(typeof(k)!='undefined'){var l=h.parent().parent().parent().find(k);if(l.length==1){var m=l.attr('editor-index');var n=s.param['editor-instance-'+m];s.lib.initAttEvents(j,function(a){s.parent.editor.insertHTML(n,k.substring(k.indexOf('.')+1),a)})}else s.lib.initAttEvents(j)}else s.lib.initAttEvents(j)}else if(h.attr('mode')=='categoryFilter'){s.lib.initCategoryFilterEvents(h)}else if(h.attr('mode')=='confirmUrlExec'){h.on('click',function(){var e=$(this);s.lib.popupConfirm(e.attr('confirm_text'),e.attr('confirm_b2'),e.attr('confirm_b3'),function(b){var c=b;var d=s.param['current-main-fileurl']+e.attr('urlexec');$.get(d,function(a){s.loadMainURLRefresh();c.parent().find('button.b3').click()})})})}else if(h.attr('mode')=='batchSwitch'){s.lib.initBatchSwitchEvents(h)}else if(h.attr('mode')=='editor'){var o=s.param['editor-index'];if(isNaN(o))o=0;var m=o+1;h.attr('editor-index',m);s.param['editor-index']=m;s.param['editor-instance-'+m]=s.parent.editor.replace(h.get(0))}else if(h.attr('mode')=='highlightLine'){h.on('click',function(){var a=$(this);if(this.checked)a.parent().parent().parent().addClass('selected');else a.parent().parent().parent().removeClass('selected')})}else if(h.attr('mode')=='highlightLineAll'){h.on('click',function(){var a=$(this);var b=$('input[name=\''+a.attr('forname')+'\']');if(this.checked){b.each(function(){if(!this.checked)this.click()})}else{b.each(function(){if(this.checked)this.click()})}})}else if(h.attr('mode')=='iconTips'){h.find('icon').each(function(){if(!$(this).is(':hidden'))h.attr('icon-hidden','no')});if(h.attr('icon-hidden')!='no')h.append('<span class="ash">'+h.attr('text-null')+'</span>')}else if(h.attr('mode')=='pagiGo'){h.on('click',function(){var a=$(this);var b=a.attr('baselink');var c=b.replace(/(\[\~page\])/g,a.parent().find('input.pagenum').val());s.loadMainURL(s.param['current-main-fileurl']+c)})}else if(h.attr('mode')=='pitchon'){var p=h.attr('upitchon')||h.attr('pitchon');if(p)h.find(p).addClass('on')}else if(h.attr('mode')=='inputSwitch'){if(h.attr('bind')!='1'){h.attr('bind','1');h.find('b').on('mouseup',function(){h.addClass('switch-1');h.find('input.val').val('1')});h.find('u').on('mouseup',function(){h.removeClass('switch-1');h.find('input.val').val('0')})}}else if(h.attr('mode')=='searchBox'){s.lib.initSearchBoxEvents(h)}else if(h.attr('mode')=='shortcut'){var q=h.parent();if(h.attr('parent')=='2')q=q.parent();else if(h.attr('parent')=='3')q=q.parent().parent();q=q.find(h.attr('shortcut'));if(!q.is(':hidden')){h.addClass('hand').on('click',function(){q.trigger('click')})}}else if(h.attr('mode')=='singleSelect'){h.find(h.attr('childtag')).click(function(){var a=$(this);a.parent().find(this.tagName).removeClass('on').eq(a.index()).addClass('on')})}else if(h.attr('mode')=='selectOption'){h.val(h.attr('val'))}else if(h.attr('mode')=='tagInput'){s.lib.initTagInputEvents(h)}else if(h.attr('mode')=='upFile'){s.lib.initUpFileEvents(h)}}})},insertHTML:function(b,c){var d=this;var e=b;var f=c;e.html(f).find('dfn').each(function(){var a=$(this);if(a.attr('url')){if(a.attr('once')=='true'){if(d.param['dfn-once-'+a.attr('onceid')]!='done'){d.param['dfn-once-'+a.attr('onceid')]='done';d.root.prepend('<script type="text/javascript" src="'+d.param['root']+a.attr('url')+'"></script>')}}else e.append('<script type="text/javascript" src="'+d.param['root']+a.attr('url')+'"></script>')}else if(a.attr('cssurl'))e.append('<link rel="stylesheet" href="'+d.param['root']+a.attr('cssurl')+'" />');else if(a.attr('call'))eval(a.attr('call'))});d.bindEventsByMode(e)},rsetWidthAndHeight:function(){var a=this;var b=$(window).height();a.obj.find('.container').css({'height':(b-a.obj.find('.topbar').height())+'px'})},loadHTML:function(){var c=this;$.get(c.manageURL,function(a){var b=$(a);if(b.find('result').attr('status')=='1')c.insertHTML(c.root,b.find('result').text())})},loadMainURL:function(e){var f=this;var g=e;var h=f.obj.find('.container').find('.main');var i=function(){h.find('nav').find('u').on('click',function(){var a=$(this);var b=a.attr('link');var c=a.attr('genre');if(b){if(c=='|self|')f.loadMainURL(b);else f.loadMainURL(f.param['root']+a.attr('genre')+'/'+a.attr('link'))}});h.find('a.link').on('click',function(){var a=$(this);var b=h.find('.manager');if(a.attr('link'))f.loadMainURL(f.param['current-main-fileurl']+a.attr('link'))});f.obj.find('nav').on('selectleftmenu',function(){var a=$(this);var b=a.attr('genre');f.obj.find('.leftmenu').find('li').removeClass('on').find('span.tit').removeClass('on');if(b){var c=f.obj.find('.leftmenu').find('span[genre=\''+b+'\']');if(c.length==1){if(!f.obj.find('.leftmenu').hasClass('min')){c.addClass('on');f.obj.find('.leftmenu').find('li').has(c).addClass('on').find('span.tit').first().addClass('open');f.obj.find('.leftmenu').find('dl').has(c).addClass('open').find('span.tit').first().addClass('open')}}}}).trigger('selectleftmenu')};if(f.param['load-main-url-lock']!=true){f.param['load-main-url-lock']=true;f.param['load-main-url-waiting']=setTimeout(function(){h.parent().find('.waiting').addClass('on')},500);$.ajax({url:g,type:'get',success:function(a){var b=$(a);if(b.find('result').attr('status')=='1'){var c=g;var d=f.param['root'];if(c.substr(0,d.length)==d)c='/'+c.substr(d.length);f.param['load-main-url']=g;location.href='#'+c;f.insertHTML(h,b.find('result').text());i();f.param['load-main-url-lock']=false;clearTimeout(f.param['load-main-url-waiting']);h.parent().find('.waiting').removeClass('on')}else this.error()},error:function(){var a=this.url;f.param['load-main-url-lock']=false;f.lib.popupAlert(h.attr('urlerror')+'<em><a href="'+f.parent.htmlEncode(a)+'" target="_blank">'+f.parent.htmlEncode(a)+'</a></em>',h.attr('ikown'),function(){clearTimeout(f.param['load-main-url-waiting']);h.parent().find('.waiting').removeClass('on')})}})}},loadMainURLRefresh:function(){var a=this;a.loadMainURL(a.param['load-main-url'])},initConsole:function(){var k=this;k.obj=k.root.find('.console');k.obj.find('.topbar').find('span.menu').click(function(){var a=$(this);if(a.parent().hasClass('min')){a.parent().removeClass('min');k.obj.find('.leftmenu').removeClass('min');k.obj.find('.leftmenu').find('span.tit.t1').removeAttr('title');k.obj.find('nav').trigger('selectleftmenu')}else{a.parent().addClass('min');k.obj.find('.leftmenu').addClass('min').find('li').removeClass('on');k.obj.find('.leftmenu').find('span.tit').removeClass('open');k.obj.find('.leftmenu').find('dl.open').removeClass('open');k.obj.find('.leftmenu').find('span.tit.t1').each(function(){$(this).attr('title',$(this).attr('mytitle'))})}});k.obj.find('.topbar').find('account').find('li.l1').click(function(){var j=$(this);if(j.attr('loading')!='true'){j.attr('loading','true');$.get(k.manageURL+'?type=modifypassword',function(f){var g=$(f);if(g.find('result').attr('status')=='1'){var h=k.lib.popupPage(g.find('result').text());var i=h.find('.tinyform');i.find('button.b2').click(function(){var c=$(this);if(!c.hasClass('lock')){c.addClass('lock');var d=c.parent().parent();var e=k.manageURL+d.attr('action');$.post(e,d.serialize(),function(a){var b=$(a);c.removeClass('lock');d.find('span.tips').addClass('h').html(b.find('result').attr('message'));if(b.find('result').attr('status')=='1')d.each(function(){this.reset()})})}})};j.attr('loading','false')})}});k.obj.find('.topbar').find('account').find('li.l2').click(function(){k.obj.find('.topbar').find('logout').trigger('click')});k.obj.find('.topbar').find('lang').each(function(){var f=$(this);$.get(k.manageURL+'?type=getlang',function(d){var e=$(d);if(e.find('result').attr('status')=='1'){f.html(e.find('result').text());f.find('li').on('click',function(){var c=$(this);if(c.attr('loading')!='true'){c.attr('loading','true');$.get(k.manageURL+'?type=action&action=setlang&lang='+encodeURIComponent(c.attr('val')),function(a){var b=$(a);c.attr('loading','false');if(b.find('result').attr('status')=='1'){k.obj.find('nav').find('u:last').trigger('click');c.parent().parent().find('b').find('flag').attr('class','f'+c.attr('val')).nextAll('span').html(k.parent.htmlEncode(c.attr('text')))}})}})}})});k.obj.find('.topbar').find('logout').click(function(){var b=$(this);k.lib.popupConfirm(b.attr('confirm_text'),b.attr('confirm_b2'),b.attr('confirm_b3'),function(){$.get(k.manageURL+'?type=action&action=logout',function(a){location.href='./'})})});k.obj.find('.leftmenu').find('span.tit').click(function(){var a=$(this);if(!k.obj.find('.leftmenu').hasClass('min')){if(a.next().hasClass('open')){a.removeClass('open');a.next().removeClass('open')}else{a.addClass('open');a.next().addClass('open')}};if(a.attr('link'))k.loadMainURL(k.param['root']+a.attr('genre')+'/'+a.attr('link'))});var l=k.obj.find('.container').find('.main').attr('def');var m=function(){var a='';if(location.href.indexOf('#')!=-1){a=location.href.substr(location.href.indexOf('#')+1);if(a.substr(0,1)=='/')a=k.param['root']+a.substr(1)};return a};k.loadMainURL(m()||l);k.rsetWidthAndHeight();$(window).on('resize',function(){k.rsetWidthAndHeight()});$(window).on('hashchange',function(){var a=m();if(a!=''&&a!=k.param['load-main-url'])k.loadMainURL(a)})},initLogin:function(){var e=this;var f=$('.login');f.find('.button .b1').click(function(){var c=$(this);if(!c.hasClass('lock')){c.addClass('lock');f.find('.message').html(c.attr('loading'));var d=f.find('form').serialize();$.post(e.manageURL+'?type=action&action=login',d,function(a){var b=$(a);c.removeClass('lock');if(b.find('result').attr('status')!='1'){f.find('.message').html(b.find('result').attr('message'))}else{e.loadHTML()}})}})},ready:function(){var a=this;a.root=$('#console');a.param['root']=a.root.attr('root');a.loadHTML()}};jtbc.console.lib={param:[],parent:jtbc.console,dragSort:function(f,g,h,i,j){var k=this;var l=f;var m=g;var n=h;var o=i;var p=j;l.on({mousemove:function(b){var c=$(this);var d=c.find(m+'.noselect');if(d.length==1){var e=null;if(b.pageY<d.offset().top||b.pageY>(d.offset().top+d.height())){c.find(m).each(function(){var a=$(this);if(b.pageY<(a.offset().top+a.height())){if(!a.hasClass('.noselect'))e=a;return false}})};if(e!=null){c.attr('change','true');if(e.index()<d.index())e.before(d);else e.after(d);o()}}},mouseup:function(){var a=$(this);$(document.body).removeClass('noselect');a.find(m+'.noselect').removeClass('noselect');if(a.attr('change')=='true'){p();a.attr('change','false')}},mouseover:function(){var a=$(this);clearTimeout(k.param[a.attr('ds')])},mouseout:function(){var a=$(this);k.param[a.attr('ds')]=setTimeout(function(){a.trigger('mouseup')},100)}});l.on('mousedown',m+' '+n,function(){var a=$(this);var b=a.parent();l.attr('ds','rnd'+Math.floor(Math.random()*1000000+1000000));$(document.body).addClass('noselect');b.find(m).removeClass('noselect');b.addClass('noselect')})},fileUp:function(f,g,h,i,j){var l=this;var m=f;var n=g;var o=h;var p=i;var q=j;var r={files:null,filecount:0,fileindex:0,formatFileInfo:function(a){var b=0;var c=a;if(c.size>1024*1024)b=(Math.round(c.size*100/(1024*1024))/100).toString()+'MB';else if(c.size>1024)b=(Math.round(c.size*100/1024)/100).toString()+'KB';else b=c.size+'B';var d=$('<div class="item"></div>');d.append('<span class="filename">'+c.name+'</span>');d.append('<span class="filesize">'+b+'</span>');d.append('<span class="bar"></span>');return d},uploadNextFile:function(){var e=this.fileindex;l.fileUpSingle(this.files[e],o,function(a){var b=false;var c='';var d=a.find('result').attr('status');if(d=='1')b=true;else if(d=='0')c=a.find('result').attr('message');if(b==false){n.find('div.item').eq(r.fileindex).addClass('error').attr('title',c).on('dblclick',function(){$(this).fadeOut()})};if(typeof(q)=='function')q(b,a,r.fileindex);r.fileindex+=1;if(r.fileindex<r.filecount)r.uploadNextFile();else p()},function(a){n.find('div.item').eq(r.fileindex).find('span.bar').css({'width':a+'%'})})},startUpload:function(){this.fileindex=0;this.uploadNextFile()}};if(m.files.length>=1){r.files=m.files;r.filecount=m.files.length;for(var k=0;k<m.files.length;k++){n.append(r.formatFileInfo(m.files[k]))};r.startUpload()}},fileUpSingle:function(g,h,i,j){var k=this;var l=g;var m=h;var n=i;var o=j;if(typeof l=='object'){var p=l.size;var q=1024*1024;var r=Math.floor(p/q);var s=0;var t='';var u=k.parent.parent.getTimeStringAndRandom();var v=function(){if(s<=r){var c=s*q;var d=Math.min(p,c+q);var e=new FormData();e.append('file',l.slice(c,d),l.name);e.append('fileSize',p);e.append('chunkCount',r);e.append('chunkCurrentIndex',s);e.append('chunkParam',t);e.append('timeStringRandom',u);var f=new XMLHttpRequest();f.upload.addEventListener('progress',function(a){var b=Math.round(s/(r+1)*100+(1/(r+1))*Math.round(a.loaded/a.total)*100);o(b)},false);f.addEventListener('load',function(a){var b=$(a.target.responseXML);if(b.find('result').attr('status')=='-1'){s+=1;t=b.find('result').attr('param');v()}else n(b)},false);f.open('POST',m);f.send(e)}};v()}},getCheckBoxValue:function(a){var b='';var c=a;c.each(function(){b+=$(this).val()+','});if(b.length>0)b=b.substring(0,b.length-1);return b},initAttEvents:function(j,k){var l=this;var m=j;var n=true;var o=k;var p=m.find('.att');var q=p.find('input[name=\''+p.attr('name')+'\']');if(typeof(o)=='undefined')n=false;var r=function(){var b=new Array();p.find('ul').find('li').each(function(){var a=$(this);if(!a.hasClass('del')){b[b.length]=a.attr('param')}});q.val(JSON.stringify(b))};var s=function(a){var b=a;var c=JSON.parse(b);var d=p.find('ul');d.find('li.null').remove();d.append('<li param="'+l.parent.parent.htmlEncode(b)+'"><em class="filetype move '+l.parent.parent.htmlEncode(c['filetype'])+'">'+l.parent.parent.htmlEncode(c['filetype'])+'</em><span class="tit">'+l.parent.parent.htmlEncode(c['filename'])+'</span><span class="size">'+l.parent.parent.htmlEncode(c['filesizetext'])+'</span><icons><icon class="insert" title="'+d.attr('text-insert')+'"></icon><icon class="delete" title="'+d.attr('text-delete')+'"></icon></icons></li>');if(n==false)d.find('icon.insert').remove();r()};var t=function(){var a=q.val();if(a){allAttObj=JSON.parse(a);for(var i in allAttObj)s(allAttObj[i])}}();l.dragSort(p.find('ul'),'li','em.filetype',function(){r()});p.find('ul').on('click','li span.tit',function(){var a=$(this);var b=a.parent();var c=JSON.parse(b.attr('param'));var d=c['filetype'];var e=c['fileurl'];if(!l.parent.parent.isAbsoluteURL(e))e=p.attr('folder')+e;var f=l.previewAtt(d,c['filename'],e,b.parent().attr('text-preview-link'),'1');f.find('input.title').on('input',function(){c['filename']=$(this).val();a.html(l.parent.parent.htmlEncode(c['filename']));b.attr('param',JSON.stringify(c));r()})});p.find('ul').on('click','li icon.insert',function(){var a=$(this);var b=a.parent().parent();var c=JSON.parse(b.attr('param'));var d=c['filetype'];if(d=='jpg'||d=='gif'||d=='png'){o('<img src="'+l.parent.parent.htmlEncode(c['fileurl'])+'" alt="" />')}else if(d=='mp4'){o('<video controls="controls" width="480" height="270"><source src="'+l.parent.parent.htmlEncode(c['fileurl'])+'" type="video/mp4" /></video>')}else{o('<a href="'+l.parent.parent.htmlEncode(c['fileurl'])+'" target="_blank">'+l.parent.parent.htmlEncode(c['filename'])+'</a>')}});p.find('ul').on('click','li icon.delete',function(){var a=$(this);var b=a.parent().parent();if(!b.hasClass('del'))b.addClass('del');else b.removeClass('del');r()});p.find('div.icons').find('icon.db').on('click',function(){var f=$(this);l.loadSelectMaterialPage('multiple',function(a){var b=a;var c=JSON.parse(b);for(var i in c){var d=JSON.parse(c[i]);var e=d['fileurl'];if(!l.parent.parent.isAbsoluteURL(e))d['fileurl']=f.attr('root')+l.parent.materialFolder+e;s(JSON.stringify(d))}})});p.find('div.icons').find('icon.upload').on('click',function(){var a=$(this);if(!a.hasClass('lock'))p.find('input.upload').trigger('click')});p.find('input.upload').on('change',function(){var h=$(this);var i=l.parent.param['current-main-fileurl']+h.attr('action');if(h.attr('uploading')!='true'){h.attr('uploading','true');m.find('.fileup').find('.item').remove();p.find('div.upload').addClass('lock');l.fileUp(this,m.find('.fileup'),i,function(){p.find('div.upload').removeClass('lock');p.find('input.upload').attr('uploading','false').val('')},function(a,b,c){var d=a;var e=b;var f=c;if(d==true){var g=e.find('result').attr('param');m.find('.fileup').find('.item').eq(f).fadeOut();s(g)}})}})},initBatchSwitchEvents:function(h){var i=this;var j=h;j.find('span.ok').click(function(){var f=$(this);var g=f.parent().find('select.batch').val();if(g!='null'){i.popupConfirm(f.attr('confirm_text'),f.attr('confirm_b2'),f.attr('confirm_b3'),function(b){var c=b;var d=i.getCheckBoxValue(j.parent().parent().find('input.id:checked'));var e=i.parent.param['current-main-fileurl']+'?type=action&action=batch';e+='&batch='+encodeURIComponent(g)+'&ids='+encodeURIComponent(d);$.get(e,function(a){i.parent.loadMainURLRefresh();c.parent().find('button.b3').click()})})}})},initCategoryFilterEvents:function(g){var h=this;var i=g;i.find('icon.category').on('click',function(){var e=$(this);if(e.attr('loading')!='true'){e.attr('loading','true');var f=h.parent.param['current-main-fileurl']+e.attr('url')+'&fid='+encodeURIComponent(e.attr('fid'));$.get(f,function(b){var c=$(b);if(c.find('result').attr('status')=='1'){e.attr('loading','false');var d=h.parent.lib.popupPage(c.find('result').text());d.find('ul.list').find('li:not(.alonetips)').on('click',function(){var a=$(this);d.find('span.close').trigger('click');h.parent.loadMainURL(h.parent.param['current-main-fileurl']+a.attr('link'))})}})}})},initUpFileEvents:function(h){var i=this;var j=h;j.find('button.upbtn').click(function(){var a=$(this);if(!a.hasClass('lock')&&!a.hasClass('show-0'))a.parent().find('input.upfiles').trigger('click')});j.find('input.fileurl').on('dblclick',function(){var a=$(this);var b=a.val();if(b&&a.attr('text-preview-title')){if(!i.parent.parent.isAbsoluteURL(b))b=i.parent.param['current-main-path']+b;i.previewAtt(null,a.attr('text-preview-title'),b,a.attr('text-preview-link'),'0')}});j.find('input.fileurl').on('input',function(){var a=$(this);var b=a.parent().find('input.upsource');if(!a.val())b.val('');else{var c=new Object();var d=b.attr('last-fileurl');var e=b.attr('last-uploadid');if(a.val()==d){c.fileurl=d;c.uploadid=e}else{c.fileurl=a.val();c.uploadid='0'};b.val(JSON.stringify(c)).trigger('update')}});j.find('input.upfiles').on('change',function(){var e=$(this);var f=e.parent().find('button.upbtn');var g=i.parent.param['current-main-fileurl']+e.attr('action');if(e.attr('uploading')!='true'){e.attr('uploading','true');f.addClass('lock').html(f.attr('uploading'));if(this.files.length==1){i.fileUpSingle(this.files[0],g,function(a){e.val('').attr('uploading','false');f.removeClass('lock').html(f.attr('text'));if(a.find('result').attr('status')=='1'){var b=new Object();var c=a.find('result').attr('param');var d=JSON.parse(c);b.fileurl=d['fileurl'];b.uploadid=d['uploadid'];e.parent().parent().find('input.upsource').val(JSON.stringify(b)).trigger('update')}else{if(e.attr('alert')=='mini')i.popupMiniAlert(a.find('result').attr('message'));else i.popupAlert(a.find('result').attr('message'),e.attr('text-ok'),function(){})};f.parent().find('span.bar').css({'width':'0%'})},function(a){f.parent().find('span.bar').css({'width':a+'%'})})}}});j.find('input.upsource').on('update',function(){var a=$(this);if(a.val()){var b=JSON.parse(a.val());var c=b['fileurl'];var d=b['uploadid'];a.parent().find('input.fileurl').val(c);if(d!='0'){a.attr('last-fileurl',c);a.attr('last-uploadid',d)}}else a.parent().find('input.fileurl').val('')});j.find('input.upsource').trigger('update')},initSearchBoxEvents:function(e){var f=this;var g=e;g.find('input.search').on('click',function(){var a=$(this);var b=a.attr('parmname')||'keyword';var c=a.parent().find('input.keyword').val();var d=f.parent.param['current-main-fileurl']+a.parent().attr('action')+'&'+b+'='+encodeURIComponent(c);f.parent.loadMainURL(d)})},initTagInputEvents:function(f){var g=this;var h=f;h.on('init',function(){var a=$(this);var b=h.find('input.val').val();if(b){var c=JSON.parse(b);for(var i in c)a.find('input.tag').val(c[i]).trigger('insert')}});h.on('click',function(){var a=$(this);a.find('input.tag').trigger('focus')});h.on('selectPrevHint',function(){var a=$(this);var b=a.find('.hints');var c=b.find('li.on').index();var d=c-1;if(c<0)d=b.find('li').length-1;b.find('li').removeClass('on').eq(d).addClass('on');a.find('input.tag').val(b.find('li.on').text())});h.on('selectNextHint',function(){var a=$(this);var b=a.find('.hints');var c=b.find('li.on').index();var d=c+1;if(c>=b.find('li').length)d=0;b.find('li').removeClass('on').eq(d).addClass('on');a.find('input.tag').val(b.find('li.on').text())});h.on('updateTag',function(){var a=$(this);var b=[];a.find('div.tags').find('span').each(function(){b.push($(this).find('em').text())});h.find('input.val').val(JSON.stringify(b));h.find('.hints').css({'top':(h.outerHeight()-2)+'px'})});h.find('.hints').on('click','li',function(){var a=$(this);h.find('input.tag').val(a.text()).trigger('insert')});h.find('div.tags').on('click','span',function(){var a=$(this);a.remove();h.trigger('updateTag')});h.find('input.tag').on('input',function(){var c=$(this);var d=c.val();if(c.attr('lock')!='true'){c.css({'width':'60px'}).css({'width':(this.scrollWidth+20)+'px'});h.find('.hints').css({'top':(h.outerHeight()-2)+'px'});if(h.attr('var1')=='1'){if(!d)h.find('.hints').removeClass('on');else{c.attr('lock','true');var e=g.parent.param['current-main-fileurl']+'?type=getTagHints&key='+encodeURIComponent(d);$.get(e,function(a){var b=$(a);if(b.find('result').attr('status')=='1'){if(b.find('result').attr('param')==d){h.find('.hints').html(b.find('result').text()).addClass('on')}};c.attr('lock','false')})}}}});h.find('input.tag').on('keyup',function(e){var a=$(this);if(e.which==13)a.trigger('insert');else if(e.which==38)h.trigger('selectPrevHint');else if(e.which==40)h.trigger('selectNextHint')});h.find('input.tag').on('keydown',function(e){if(e.which==13)return false});h.find('input.tag').on('insert',function(){var b=$(this);var c=b.val();var d=b.parent();if(c){var e=false;d.find('span').each(function(){var a=$(this);if(a.find('em').text()==c)e=true});b.val('');d.parent().find('.hints').removeClass('on');if(e==false)b.before('<span><em>'+g.parent.parent.htmlEncode(c)+'</em><x></x></span>');h.trigger('updateTag')}});h.find('input.tag').on('focus',function(){h.addClass('focus')});h.find('input.tag').on('blur',function(){h.removeClass('focus')});h.trigger('init')},initMainCommon:function(a){var b=a;b.obj=b.parent.obj.find('.manager');try{b.parent.parent.editor.baseHref=b.obj.attr('folder')}catch(e){};b.parent.param['current-main-path']=b.parent.param['root']+b.obj.attr('genre')+'/';b.parent.param['current-main-fileurl']=b.param['fileurl']=b.parent.param['current-main-path']+b.obj.attr('filename');var c=b.obj.attr('module');var d='init'+c.substring(0,1).toUpperCase()+c.substring(1);if(b.hasOwnProperty(d))eval('myObj.'+d+'();')},loadSelectMaterialPage:function(h,i){var j=this;var k=h;var l=i;var m=j.parent.param['root']+j.parent.materialFolder+j.parent.managerapiURL+'?type=list&mode='+encodeURIComponent(k);if(j.param['select-material-loading']!=true){j.param['select-material-loading']=true;$.get(m,function(e){var f=$(e);if(f.find('result').attr('status')=='1'){var g=j.popupPage('');j.parent.insertHTML(g.find('.content'),f.find('result').text());g.on('reload','.substance',function(){var c=$(this);if(j.param['select-material-loading']!=true){j.param['select-material-loading']=true;var d=m+'&get=reload&'+c.attr('reloadparam');$.get(d,function(a){var b=$(a);if(b.find('result').attr('status')=='1'){j.parent.insertHTML(g.find('.content'),b.find('result').text());j.param['select-material-loading']=false}})}});g.on('click','button.b2',function(){g.find('span.close').trigger('click');l(g.find('input[name=\'material\']').val())});j.param['select-material-loading']=false}})}},previewAtt:function(a,b,c,d,e){var f=this;var g=a;var h=b;var i=c;var j=d;var k=e;var l='';if(g==null){var m=i.split('.');g=m[m.length-1]};if(k=='0')l+='<div class="title">'+f.parent.parent.htmlEncode(h)+'</div>';else if(k=='1')l+='<div class="title"><input type="text" class="title" value="'+f.parent.parent.htmlEncode(h)+'" /></div>';if(g=='jpg'||g=='gif'||g=='png'){l+='<div class="attPreview"><img class="item" src="'+f.parent.parent.htmlEncode(i)+'" /></div>'}else{l+='<div class="attPreview"><a class="item" href="'+f.parent.parent.htmlEncode(i)+'" target="_blank">'+f.parent.parent.htmlEncode(j)+'</a></div>'};var n=f.popupPage(l);return n},popupAlert:function(a,b,c){var d=this;var e=a;var f=b;var g=c;var h=d.parent.root;if(h.find('.popup_mask').length==0)h.append('<div class="popup_mask"></div>');if(h.find('.popup_alert').length==1)h.find('.popup_alert').remove();h.append('<div class="popup_alert"><div class="title"></div><div class="word"></div><div class="button"><button class="b2">'+f+'</button></div></div>');var i=h.find('.popup_alert');var j=h.find('.popup_mask');i.find('.word').html(e);i.find('button.b2').click(function(){g($(this));j.removeClass('on');i.removeClass('on')});d.param['popup-alert-timeout']=setTimeout(function(){j.addClass('on');i.addClass('on')},100);return i},popupMiniAlert:function(a){var b=this;var c=a;var d=b.parent.root;d.find('.popup_minialert').remove();d.append('<div class="popup_minialert"><div class="word"></div></div>');var e=d.find('.popup_minialert');e.find('.word').html(c);clearTimeout(b.param['popup-minialert-timeout']);clearTimeout(b.param['popup-minialert-disappear-timeout']);b.param['popup-minialert-timeout']=setTimeout(function(){e.addClass('on')},100);b.param['popup-minialert-disappear-timeout']=setTimeout(function(){e.removeClass('on')},2000);return e},popupConfirm:function(b,c,d,e){var f=this;var g=b;var h=c;var i=d;var j=e;var k=f.parent.root;if(k.find('.popup_mask').length==0)k.append('<div class="popup_mask"></div>');if(k.find('.popup_confirm').length==1)k.find('.popup_confirm').remove();k.append('<div class="popup_confirm"><div class="title"></div><div class="word"></div><div class="button"><button class="b3">'+i+'</button><button class="b2">'+h+'</button></div></div>');var l=k.find('.popup_confirm');var m=k.find('.popup_mask');l.find('.word').html(g);l.find('button.b2').click(function(){var a=$(this);if(!a.hasClass('lock')){a.addClass('lock');j($(this))}});l.find('button.b3').click(function(){m.removeClass('on');l.removeClass('on')});f.param['popup-confirm-timeout']=setTimeout(function(){m.addClass('on');l.addClass('on')},100);return l},popupPage:function(c){var d=this;var e=c;var f=d.parent.root;if(f.find('.popup_mask').length==0)f.append('<div class="popup_mask"></div>');if(f.find('.popup_page').length==1)f.find('.popup_page').remove();f.append('<div class="popup_page"><span class="close"></span><div class="content"></div></div>');var g=f.find('.popup_page');var h=f.find('.popup_mask');g.find('div.content').html(e);d.parent.bindEventsByMode(g);g.find('span.close').click(function(){h.removeClass('on');g.removeClass('on')});var i=function(){g.css({'min-width':'auto','min-height':'auto'});var a=Math.round(g.width());var b=Math.round(g.height());if(a%2==1)a=a+1;if(b%2==1)b=b+1;if(a!=0&&b!=0)g.css({'min-width':a+'px','min-height':b+'px'});requestAnimationFrame(i)};d.param['popup-page-timeout']=setTimeout(function(){h.addClass('on');g.addClass('on')},100);i();return g}};